<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-TFC">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mikrobesin Referans Değerleri Karşılaştırması</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .chart-container {
            position: relative;
            height: 500px;
            width: 100%;
        }
        /* Custom checkbox style */
        .custom-checkbox:checked {
            background-color: currentColor;
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
        }
    </style>
</head>
<body class="text-gray-800">

<div class="container mx-auto p-4 sm:p-6 md:p-8 relative">
    <div class="absolute top-4 right-4 sm:top-6 sm:right-6 md:top-8 md:right-8 z-10">
        <button onclick="switchLanguage('tr')" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-l-md">TR</button>
        <button onclick="switchLanguage('en')" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-r-md">EN</button>
    </div>
    <header class="text-center mb-10">
            <h1 id="main-title" class="text-3xl md:text-4xl font-bold text-gray-900">Mikrobesin Referans Değerleri</h1>
            <p id="subtitle" class="mt-2 text-md text-gray-600">EFSA, FNB ve TFC verilerinin 0-18 yaş aralığı için karşılaştırmalı analizi</p>
        </header>

        <main>
            <div class="max-w-xl mx-auto mb-8">
                <label for="nutrient-select" id="nutrient-select-label" class="block text-sm font-medium text-gray-700 mb-2">Analiz Edilecek Mikrobesini Seçin:</label>
                <select id="nutrient-select" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 shadow-sm transition duration-150 ease-in-out">
                    </select>
            </div>

            <div id="charts-wrapper" class="space-y-12">
                </div>

            <div id="controls-container" class="mt-8 p-6 bg-white rounded-xl shadow-md max-w-2xl mx-auto">
                 <h3 id="controls-title" class="text-lg font-semibold text-center mb-4 text-gray-800">Grafik Kontrolleri</h3>
                 <div id="checkbox-controls" class="flex justify-center items-center gap-6 sm:gap-8 flex-wrap">
                    </div>
            </div>
        </main>
    </div>
    
    <script src="data.js"></script>
    <script>
        // --- TRANSLATION DATA ---
        const translations = {
            tr: {
                title: "Mikrobesin Referans Değerleri",
                subtitle: "EFSA, FNB ve TFC verilerinin 0-18 yaş aralığı için karşılaştırmalı analizi",
                nutrientSelectLabel: "Analiz Edilecek Mikrobesini Seçin:",
                controlsTitle: "Grafik Kontrolleri",
                intakeChartTitle: "Önerilen Alım Değerleri",
                ulChartTitle: "Üst Limit Değerleri",
                yAxisLabel: (unit) => `Değer (${unit})`,
                xAxisLabel: "Yaş",
                noDataMessage: "Bu kategori için veri bulunamadı.",
                genderMale: "Erkek",
                genderFemale: "Kadın"
            },
            en: {
                title: "Micronutrient Reference Values",
                subtitle: "Comparative analysis of EFSA, FNB, and TFC data for the 0-18 age range",
                nutrientSelectLabel: "Select Micronutrient to Analyze:",
                controlsTitle: "Chart Controls",
                intakeChartTitle: "Recommended Intake Values",
                ulChartTitle: "Upper Limit Values",
                yAxisLabel: (unit) => `Value (${unit})`,
                xAxisLabel: "Age",
                noDataMessage: "No data available for this category.",
                genderMale: "Male",
                genderFemale: "Female"
            }
        };

        let currentLang = 'tr'; // Default language

        // --- GLOBAL VARIABLES ---
        let charts = [];
        const sourceColors = {
            EFSA: 'rgba(54, 162, 235, 1)',
            FNB: 'rgba(255, 99, 132, 1)',
            TFC: 'rgba(75, 192, 192, 1)'
        };
        const sourceBorderDash = {
            EFSA: [],
            FNB: [5, 5],
            TFC: [10, 5, 2, 5]
        };
        const genderColors = {
            Male: 'rgba(54, 162, 235, 1)', // Blue for Male
            Female: 'rgba(255, 99, 132, 1)', // Red for Female
            Both: 'rgba(75, 192, 192, 1)' // Green for Both
        };

        // --- LANGUAGE SWITCHING ---
        function switchLanguage(lang) {
            currentLang = lang;
            document.documentElement.lang = lang;
            const t = translations[lang];

            document.getElementById('main-title').textContent = t.title;
            document.getElementById('subtitle').textContent = t.subtitle;
            document.getElementById('nutrient-select-label').textContent = t.nutrientSelectLabel;
            document.getElementById('controls-title').textContent = t.controlsTitle;
            
            // Re-render the charts with the new language
            const selectedNutrient = document.getElementById('nutrient-select').value;
            renderCharts(selectedNutrient, lang);
        }

        // --- UTILITY FUNCTIONS ---
        function createSteppedData(data) {
            const points = [];
            data.sort((a,b) => a.age_start - b.age_start).forEach(item => {
                points.push({ x: item.age_start, y: item.value });
                points.push({ x: item.age_end, y: item.value });
                const nextItemIndex = data.indexOf(item) + 1;
                if (nextItemIndex < data.length) {
                    if (data[nextItemIndex].age_start > item.age_end) {
                        points.push({ x: item.age_end, y: null });
                    }
                }
            });
            return points;
        }

        // --- CHARTING FUNCTIONS ---
        function clearCharts() {
            charts.forEach(chart => chart.destroy());
            charts = [];
            document.getElementById('charts-wrapper').innerHTML = '';
        }

        function renderCharts(nutrientName, lang = 'tr') {
            clearCharts();
            const nutrientData = micronutrientData.filter(d => d.nutrient === nutrientName);
            if (nutrientData.length === 0) return;

            const unit = nutrientData.length > 0 ? nutrientData[0].unit : '';
            const t = translations[lang];

            const intakeData = nutrientData.filter(d => ['AI', 'AR', 'PRI', 'RI', 'Safe and adequate intake', 'RDA', 'DRV'].includes(d.type));
            const ulData = nutrientData.filter(d => ['UL', 'DML'].includes(d.type));
            
            const wrapper = document.createElement('div');
            wrapper.className = 'bg-white p-4 sm:p-6 rounded-xl shadow-lg';
            wrapper.innerHTML = `
                <h2 class="text-xl md:text-2xl font-bold text-center mb-6 text-gray-800">${nutrientName}</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="chart-container">
                        <canvas id="intake-chart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="ul-chart"></canvas>
                    </div>
                </div>
            `;
            document.getElementById('charts-wrapper').appendChild(wrapper);

            createChart(
                `intake-chart`,
                t.intakeChartTitle,
                intakeData,
                t.yAxisLabel(unit),
                lang
            );
            createChart(
                `ul-chart`,
                t.ulChartTitle,
                ulData,
                t.yAxisLabel(unit),
                lang
            );
        }

        function createChart(canvasId, title, data, yAxisLabel, lang = 'tr') {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            
            const t = translations[lang];
            const datasets = [];
            const sources = ['EFSA', 'FNB', 'TFC'];
            
            sources.forEach(source => {
                const sourceData = data.filter(d => d.source === source);
                const types = [...new Set(sourceData.map(d => d.type))];

                types.forEach(type => {
                    const typeData = sourceData.filter(d => d.type === type);
                    const genders = [...new Set(typeData.map(d => d.gender))];

                    genders.forEach(gender => {
                        const genderFilteredData = typeData.filter(d => d.gender === gender);
                        
                        if (genderFilteredData.length > 0) {
                            let label = `${source} - ${type}`;
                            if (gender !== 'Both') {
                                label += ` (${gender === 'Male' ? t.genderMale : t.genderFemale})`;
                            }
                            
                            let borderColor = sourceColors[source];
                            if (genders.includes('Male') && genders.includes('Female')) {
                                borderColor = gender === 'Male' ? 'rgba(54, 162, 235, 1)' : 'rgba(255, 99, 132, 1)';
                            }

                            datasets.push({
                                label: label,
                                data: createSteppedData(genderFilteredData),
                                borderColor: borderColor,
                                backgroundColor: borderColor.replace('1)', '0.2)'),
                                borderWidth: 2.5,
                                pointRadius: 0,
                                tension: 0,
                                stepped: 'before',
                                borderDash: sourceBorderDash[source],
                                spanGaps: true, 
                            });
                        }
                    });
                });
            });

            if (datasets.length === 0) {
                const p = document.createElement('p');
                p.className = 'flex items-center justify-center h-full text-gray-500';
                p.textContent = t.noDataMessage;
                ctx.parentElement.innerHTML = '';
                ctx.parentElement.appendChild(p);
                return;
            }

            const chart = new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: title, font: { size: 16 } },
                        legend: { display: true, position: 'bottom' },
                        tooltip: { 
                            mode: 'index', 
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y;
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            title: { display: true, text: t.xAxisLabel },
                            min: 0,
                            max: 18,
                            ticks: { stepSize: 2 }
                        },
                        y: {
                            title: { display: true, text: yAxisLabel },
                            beginAtZero: true
                        }
                    }
                }
            });
            charts.push(chart);
        }

        // --- CONTROLS AND INITIALIZATION ---
        function setupControls() {
            const controlsDiv = document.getElementById('checkbox-controls');
            controlsDiv.innerHTML = ''; // Clear previous controls
            const sources = ['EFSA', 'FNB', 'TFC'];
            
            sources.forEach(source => {
                const color = sourceColors[source];
                const controlHtml = `
                    <label for="${source}-checkbox" class="flex items-center cursor-pointer">
                        <input type="checkbox" id="${source}-checkbox" class="custom-checkbox appearance-none h-5 w-5 rounded border-2 transition duration-200" style="color: ${color}; border-color: ${color};" checked>
                        <span class="ml-2 text-md font-medium text-gray-700">${source}</span>
                    </label>
                `;
                controlsDiv.innerHTML += controlHtml;
            });

            sources.forEach(source => {
                document.getElementById(`${source}-checkbox`).addEventListener('change', (e) => {
                    const isVisible = e.target.checked;
                    charts.forEach(chart => {
                        chart.data.datasets.forEach(dataset => {
                            if (dataset.label.startsWith(source)) {
                                dataset.hidden = !isVisible;
                            }
                        });
                        chart.update();
                    });
                });
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const selectElement = document.getElementById('nutrient-select');
            const nutrients = [...new Set(micronutrientData.map(d => d.nutrient))].sort();

            nutrients.forEach(nutrient => {
                const option = document.createElement('option');
                option.value = nutrient;
                option.textContent = nutrient;
                selectElement.appendChild(option);
            });

            selectElement.addEventListener('change', (e) => {
                renderCharts(e.target.value, currentLang);
            });

            if (nutrients.length > 0) {
                setupControls();
                switchLanguage('tr'); // Set default language to Turkish on load
            }
        });

    </script>
</body>
</html>
